YUI.add("moodle-atto_teamsmeeting-button",function(e,t){var n={NEWWINDOW:"atto_teamsmeeting_openinnewwindow",URLINPUT:"atto_teamsmeeting_urlentry"},i=".atto_teamsmeeting_urlentry";e.namespace("M.atto_teamsmeeting").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_clientdomain:null,_appurl:null,_locale:null,_msession:null,initializer:function(){this._clientdomain=this.get("clientdomain"),this._appurl=this.get("appurl"),this._locale=this.get("locale"),this._msession=this.get("msession"),this.addButton({icon:"icon",iconComponent:"atto_teamsmeeting",callback:this._displayDialogue,tags:"a",tagMatchRequiresAll:!1})},_displayDialogue:function(){if(this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection){var e=this.getDialogue({headerContent:M.util.get_string("createteamsmeeting","atto_teamsmeeting"),width:"auto",focusAfterHide:!0,focusOnShowSelector:i});e.set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),e.show()}},_resolveAnchors:function(){var t,n,i,o,s=this.get("host").getSelectionParentNode();if(s&&(t=this._findSelectedAnchors(e.one(s))).length>0){if(n=t[0],this._currentSelection=this.get("host").getSelectionFromNode(n),i=n.getAttribute("href"),o=n.getAttribute("target"),""!==i){this._content.one(".url").setAttribute("value",i);var a=M.cfg.wwwroot+"/lib/editor/atto/plugins/teamsmeeting/ajax.php",l={url:i};e.io(a,{context:this,data:l,timeout:500,on:{complete:this._updateIframe}})}"_blank"===o?this._content.one(".newwindow").setAttribute("checked","checked"):this._content.one(".newwindow").removeAttribute("checked")}},_meetingcheck:function(){if(document.getElementById("meetingapp").contentDocument){var e=document.getElementById("meetingapp").contentDocument.location;if(""!==e&&e.pathname.indexOf("teamsmeeting")>-1){var t=this._getqueryvariable("link",e);this._content.one(".url").set("value",t)}}},_updateIframe:function(e,t){if(200===t.status){var n=JSON.parse(t.responseText);if(null!==n[2]){var i=n[0]+"?title="+n[1]+"&link="+encodeURIComponent(n[2])+"&options="+encodeURIComponent(n[3]);this._content.one("#meetingapp").set("src",i)}}},_getqueryvariable:function(e,t){for(var n=t.search.substring(1).split("&"),i=0;i<n.length;i++){var o=n[i].split("=");if(decodeURIComponent(o[0])==e)return decodeURIComponent(o[1])}},_setteamsmeeting:function(e){var t;(e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),""!==(t=this._content.one(".url").get("value")))&&(t=t.trim(),new RegExp(/^[a-zA-Z]*\.*\/|^#|^[a-zA-Z]*:/).test(t)||(t="http://"+t),this._setteamsmeetingOnSelection(t),this.markUpdated())},_setteamsmeetingOnSelection:function(t){var n,i,o,s=this.get("host");if(this.editor.focus(),s.setSelection(this._currentSelection),this._currentSelection[0].collapsed){var a='<img src="'+this._clientdomain+'/lib/editor/atto/plugins/teamsmeeting/pix/icon.png" class="icon" />';(n=e.Node.create("<a>"+a+"Teams Meeting Link</a>")).setAttribute("href",t),i=s.insertContentAtFocusPoint(n.get("outerHTML")),s.setSelection(s.getSelectionFromNode(i))}else document.execCommand("unlink",!1,null),document.execCommand("createlink",!1,t),i=s.getSelectionParentNode();if(i)return o=this._findSelectedAnchors(e.one(i)),e.Array.each(o,function(e){this._content.one(".newwindow").get("checked")?e.setAttribute("target","_blank"):e.removeAttribute("target")},this),i},_findSelectedAnchors:function(e){var t,n,i=e.get("tagName");return i&&"a"===i.toLowerCase()?[e]:(n=[],e.all("a").each(function(e){!t&&this.get("host").selectionContainsNode(e)&&n.push(e)},this),n.length>0?n:(t=e.ancestor("a"))?[t]:[])},_getDialogueContent:function(){var t=e.Handlebars.compile('<form class="atto_form"><div class="meeting-app"><label class="meeting-app-label" for="meetingapp">{{get_string "createteamsmeeting" component}}</label><iframe id="meetingapp" src="{{appurl}}?url={{clientdomain}}&locale={{locale}}&msession={{msession}}"></iframe></div><div class="mb-1"><label for="{{elementid}}_atto_teamsmeeting_urlentry">{{get_string "meetingurl" component}}</label><input class="form-control fullwidth url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_teamsmeeting_urlentry" size="32" disabled="disabled"/></div><div class="form-check"><input type="checkbox" class="form-check-input newwindow" id="{{elementid}}_{{CSS.NEWWINDOW}}"/><label class="form-check-label" for="{{elementid}}_{{CSS.NEWWINDOW}}">{{get_string "openinnewwindow" component}}</label></div><div class="mdl-align"><br/><button type="submit" class="btn btn-secondary submit">{{get_string "addlink" component}}</button></div></form>');return this._content=e.Node.create(t({clientdomain:this._clientdomain,appurl:this._appurl,locale:this._locale,msession:this._msession,component:"atto_teamsmeeting",CSS:n})),this._content.one(".submit").on("click",this._setteamsmeeting,this),this._content.one("iframe").on("load",this._meetingcheck,this),this._content}},{ATTRS:{clientdomain:{value:null},appurl:{value:null},locale:{value:null},msession:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});